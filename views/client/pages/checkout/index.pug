extends ../../layouts/default.pug
include ../../mixins/box-head.pug
include ../../mixins/alert.pug

block main 
    +alert-success(5000)
    +alert-error(5000) 

    // Page Header
    section.page-header.bg-light.py-4.mb-4
        .container
            .row.align-items-center
                .col-md-8
                    h1.page-title.fw-bold.mb-2
                        i.fas.fa-credit-card.me-2
                        | Thanh toán đơn hàng
                    nav(aria-label="breadcrumb")
                        ol.breadcrumb.mb-0
                            li.breadcrumb-item
                                a.text-decoration-none(href="/") Trang chủ
                            li.breadcrumb-item
                                a.text-decoration-none(href="/cart") Giỏ hàng
                            li.breadcrumb-item.active(aria-current="page") Thanh toán
                .col-md-4.text-md-end
                    if cartDetail.products && cartDetail.products.length > 0
                        span.badge.bg-success.fs-6 
                            i.fas.fa-shopping-bag.me-1
                            | #{cartDetail.products.length} sản phẩm

    // Checkout Progress
    section.checkout-progress.py-4.mb-5
        .container
            .progress-steps.bg-white.rounded-4.shadow.p-4.position-relative
                // Progress Bar Background
                .progress-bar-container.position-absolute.d-none.d-md-block(style="top: 50%; left: 10%; right: 10%; height: 3px; transform: translateY(-50%); z-index: 1;")
                    .progress-bar-bg.bg-light.w-100.rounded-pill(style="height: 100%;")
                    .progress-bar-fill.bg-primary.rounded-pill(style="height: 100%; width: 50%; transition: width 0.3s ease;")
                
                .row.text-center.position-relative(style="z-index: 2;")
                    .col-md-4.col-12.mb-3.mb-md-0
                        .step.completed.position-relative
                            .step-wrapper.d-flex.flex-column.align-items-center
                                .step-number-container.position-relative.mb-3
                                    .step-icon.bg-success.text-white.rounded-circle.mx-auto.d-flex.align-items-center.justify-content-center.shadow-sm.position-relative(style="width: 60px; height: 60px; z-index: 3;")
                                        .step-number.position-absolute.top-0.start-0.bg-white.text-success.rounded-circle.d-flex.align-items-center.justify-content-center.fw-bold.small(style="width: 20px; height: 20px; margin-top: -8px; margin-left: -8px;") 1
                                        i.fas.fa-shopping-cart.fa-lg
                                    .step-check.position-absolute.bottom-0.end-0.bg-success.text-white.rounded-circle.d-flex.align-items-center.justify-content-center(style="width: 24px; height: 24px; margin-bottom: -8px; margin-right: -8px;")
                                        i.fas.fa-check.fa-xs
                                .step-content
                                    .step-label.fw-bold.text-success.mb-1 Giỏ hàng
                                    .step-description.small.text-muted Đã chọn sản phẩm
                    
                    .col-md-4.col-12.mb-3.mb-md-0
                        .step.active.position-relative
                            .step-wrapper.d-flex.flex-column.align-items-center
                                .step-number-container.position-relative.mb-3
                                    .step-icon.bg-primary.text-white.rounded-circle.mx-auto.d-flex.align-items-center.justify-content-center.shadow-sm.position-relative(style="width: 60px; height: 60px; z-index: 3; animation: pulse 2s infinite;")
                                        .step-number.position-absolute.top-0.start-0.bg-white.text-primary.rounded-circle.d-flex.align-items-center.justify-content-center.fw-bold.small(style="width: 20px; height: 20px; margin-top: -8px; margin-left: -8px;") 2
                                        i.fas.fa-credit-card.fa-lg
                                .step-content
                                    .step-label.fw-bold.text-primary.mb-1 Thanh toán
                                    .step-description.small.text-muted Đang nhập thông tin
                    
                    .col-md-4.col-12
                        .step.pending.position-relative
                            .step-wrapper.d-flex.flex-column.align-items-center
                                .step-number-container.position-relative.mb-3
                                    .step-icon.bg-light.text-muted.rounded-circle.mx-auto.d-flex.align-items-center.justify-content-center.shadow-sm.position-relative(style="width: 60px; height: 60px; z-index: 3;")
                                        .step-number.position-absolute.top-0.start-0.bg-white.text-muted.rounded-circle.d-flex.align-items-center.justify-content-center.fw-bold.small(style="width: 20px; height: 20px; margin-top: -8px; margin-left: -8px;") 3
                                        i.fas.fa-check-circle.fa-lg
                                .step-content
                                    .step-label.fw-bold.text-muted.mb-1 Hoàn thành
                                    .step-description.small.text-muted Xác nhận đơn hàng

    // Main Checkout Content
    section.checkout-section.py-4
        .container
            if cartDetail.products && cartDetail.products.length > 0
                .row
                    // Order Form
                    .col-lg-8.mb-4
                        .checkout-form.bg-white.rounded-3.shadow-sm.p-4
                            h5.fw-bold.mb-4
                                i.fas.fa-user.me-2
                                | Thông tin giao hàng
                            
                            form(
                                action=`/checkout/order`
                                method="POST"
                                id="checkoutForm"
                            )
                                .row
                                    // Thông tin cá nhân
                                    .col-md-12.mb-3
                                        label.form-label.fw-semibold(for="fullName")
                                            i.fas.fa-user.me-2.text-primary
                                            | Họ và tên 
                                            span.text-danger *
                                        input.form-control.form-control-lg(
                                            type="text"
                                            id="fullName"
                                            name="fullName"
                                            placeholder="Nhập họ và tên đầy đủ"
                                            required 
                                        ) 
                                    
                                    .col-md-6.mb-3
                                        label.form-label.fw-semibold(for="phone")
                                            i.fas.fa-phone.me-2.text-primary
                                            | Số điện thoại 
                                            span.text-danger *
                                        input.form-control.form-control-lg(
                                            type="tel"
                                            id="phone"
                                            name="phone"
                                            placeholder="Nhập số điện thoại"
                                            required 
                                        ) 
                                    
                                    .col-md-6.mb-3
                                        label.form-label.fw-semibold(for="email")
                                            i.fas.fa-envelope.me-2.text-primary
                                            | Email 
                                            span.text-muted (tùy chọn)
                                        input.form-control.form-control-lg(
                                            type="email"
                                            id="email"
                                            name="email"
                                            placeholder="Nhập địa chỉ email"
                                        )
                                    
                                    // Thông tin giao hàng
                                    .col-md-12.mb-3
                                        label.form-label.fw-semibold(for="address")
                                            i.fas.fa-map-marker-alt.me-2.text-primary
                                            | Địa chỉ giao hàng 
                                            span.text-danger *
                                        textarea.form-control.form-control-lg(
                                            id="address"
                                            name="address"
                                            rows="3"
                                            placeholder="Nhập địa chỉ chi tiết (số nhà, tên đường, phường/xã, quận/huyện, tỉnh/thành)"
                                            required 
                                        )
                                    
                                    .col-md-12.mb-3
                                        label.form-label.fw-semibold(for="notes")
                                            i.fas.fa-sticky-note.me-2.text-primary
                                            | Ghi chú đơn hàng 
                                            span.text-muted (tùy chọn)
                                        textarea.form-control.form-control-lg(
                                            id="notes"
                                            name="notes"
                                            rows="3"
                                            placeholder="Thêm ghi chú cho người giao hàng (ví dụ: giao vào buổi chiều, gọi trước khi giao...)"
                                        )

                                // Payment Method
                                .payment-method.mb-4
                                    h6.fw-bold.mb-3
                                        i.fas.fa-credit-card.me-2
                                        | Phương thức thanh toán
                                    .row
                                        .col-md-6.mb-3
                                            .payment-option.border.rounded-3.p-3.h-100
                                                .form-check
                                                    input.form-check-input(type="radio" name="paymentMethod" id="cod" value="cod" checked)
                                                    label.form-check-label.w-100(for="cod")
                                                        .d-flex.align-items-center
                                                            .payment-icon.me-3
                                                                i.fas.fa-money-bill-wave.fa-2x.text-success
                                                            .payment-info
                                                                .fw-semibold Thanh toán khi nhận hàng
                                                                .small.text-muted COD - Cash on Delivery
                                        .col-md-6.mb-3
                                            .payment-option.border.rounded-3.p-3.h-100
                                                .form-check
                                                    input.form-check-input(type="radio" name="paymentMethod" id="online" value="online" disabled)
                                                    label.form-check-label.w-100(for="online")
                                                        .d-flex.align-items-center
                                                            .payment-icon.me-3
                                                                i.fas.fa-credit-card.fa-2x.text-primary
                                                            .payment-info
                                                                .fw-semibold Thanh toán online
                                                                .small.text-muted 
                                                                    | Sắp ra mắt
                                                                    .badge.bg-warning.text-dark.ms-1 Coming soon

                    // Order Summary
                    .col-lg-4
                        .order-summary.bg-white.rounded-3.shadow-sm.p-4.sticky-top
                            h5.fw-bold.mb-4
                                i.fas.fa-receipt.me-2
                                | Tóm tắt đơn hàng
                            
                            // Product List
                            .order-items.mb-4
                                each item, index in cartDetail.products
                                    .order-item.d-flex.align-items-center.mb-3(class=index === cartDetail.products.length - 1 ? 'mb-3' : 'pb-3 border-bottom')
                                        .item-image.me-3
                                            img.rounded(
                                                src=item.productInfo.thumbnail
                                                alt=item.productInfo.title
                                                style="width: 50px; height: 50px; object-fit: cover;"
                                            )
                                        .item-details.flex-grow-1
                                            .item-name.fw-semibold.small #{item.productInfo.title}
                                            .item-quantity.text-muted.small Số lượng: #{item.quantity}
                                        .item-price.fw-bold.text-primary #{item.totalPrice}$
                            
                            // Summary Calculations
                            .summary-calculations
                                .summary-row.d-flex.justify-content-between.mb-2
                                    span Tạm tính:
                                    span.fw-semibold #{cartDetail.totalPrice}$
                                
                                .summary-row.d-flex.justify-content-between.mb-2
                                    span Phí vận chuyển:
                                    span.text-success
                                        i.fas.fa-gift.me-1
                                        | Miễn phí
                                
                                .summary-row.d-flex.justify-content-between.mb-2
                                    span Thuế VAT:
                                    span Đã bao gồm
                                
                                hr.my-3
                                
                                .summary-total.d-flex.justify-content-between.mb-4
                                    span.fw-bold.fs-5 Tổng cộng:
                                    span.fw-bold.text-primary.fs-4 #{cartDetail.totalPrice}$
                            
                            // Action Buttons
                            .checkout-actions.d-grid.gap-2
                                button.btn.btn-primary.btn-lg(
                                    type="submit"
                                    form="checkoutForm"
                                )
                                    i.fas.fa-check.me-2
                                    | Xác nhận đặt hàng
                                
                                a.btn.btn-outline-secondary(href="/cart")
                                    i.fas.fa-arrow-left.me-2
                                    | Quay lại giỏ hàng

            else
                // Empty Cart State
                .empty-checkout.text-center.py-5
                    .empty-content.bg-white.rounded-3.shadow-sm.p-5.mx-auto(style="max-width: 500px;")
                        i.fas.fa-shopping-cart.fa-4x.text-muted.mb-4
                        h3.fw-bold.text-muted.mb-3 Giỏ hàng trống
                        p.text-muted.mb-4 Bạn cần có sản phẩm trong giỏ hàng để tiến hành thanh toán.
                        .empty-actions
                            a.btn.btn-primary.btn-lg(href="/products")
                                i.fas.fa-shopping-bag.me-2
                                | Bắt đầu mua sắm

    // Custom CSS for checkout page
    style.
        /* Checkout Progress Styling */
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.7);
            }
            70% {
                box-shadow: 0 0 0 8px rgba(13, 110, 253, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(13, 110, 253, 0);
            }
        }
        
        .checkout-progress .step-icon {
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }
        
        .checkout-progress .step.completed .step-icon {
            border-color: rgba(25, 135, 84, 0.2);
        }
        
        .checkout-progress .step.active .step-icon {
            border-color: rgba(13, 110, 253, 0.2);
        }
        
        .checkout-progress .step-number {
            font-size: 0.75rem;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .checkout-progress .step-check {
            font-size: 0.7rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .checkout-progress .step-wrapper:hover .step-icon {
            transform: scale(1.05);
        }
        
        /* Progress Bar Animation */
        .progress-bar-fill {
            background: linear-gradient(90deg, #0d6efd, #198754);
            box-shadow: 0 2px 4px rgba(13, 110, 253, 0.3);
        }
        
        /* Payment Options */
        .payment-option {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .payment-option:hover {
            border-color: #0d6efd !important;
            background-color: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .payment-option input:checked + label .payment-option {
            border-color: #0d6efd;
            background-color: #e7f3ff;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .checkout-progress .step-icon {
                width: 50px !important;
                height: 50px !important;
            }
            
            .checkout-progress .step-number {
                width: 18px !important;
                height: 18px !important;
                margin-top: -6px !important;
                margin-left: -6px !important;
            }
            
            .checkout-progress .step-check {
                width: 20px !important;
                height: 20px !important;
                margin-bottom: -6px !important;
                margin-right: -6px !important;
            }
            
            .order-summary {
                position: static !important;
            }
            
            .progress-bar-container {
                display: none !important;
            }
        }
        
        @media (max-width: 576px) {
            .checkout-progress .step-wrapper {
                padding: 0 10px;
            }
            
            .checkout-progress .step-label {
                font-size: 0.9rem;
            }
            
            .checkout-progress .step-description {
                font-size: 0.8rem;
            }
        }
        
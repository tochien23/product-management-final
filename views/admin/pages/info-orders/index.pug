extend ../../layouts/default.pug
include ../../mixins/filter-status.pug
include ../../mixins/search.pug
include ../../mixins/pagination.pug
include ../../mixins/form-change-multi.pug
include ../../mixins/alert.pug
include ../../mixins/sort.pug
include ../../mixins/moment.pug

block main
    if(role.permissions.includes("orders_view"))
        +alert-success(5000)
        
        // Header
        .d-flex.justify-content-between.align-items-center.mb-4
            h2.fw-bold.text-dark.mb-0 Quản lý đơn hàng khách hàng
            .d-flex.gap-2
                span.badge.bg-primary.fs-6.px-3.py-2
                    i.fas.fa-shopping-cart.me-1
                    | #{orders ? orders.length : 0} đơn hàng

        // Filter Section
        .row.g-3.mb-4
            .col-md-6
                .bg-white.p-3.rounded.border
                    label.form-label.fw-semibold.mb-2 Tìm kiếm
                    +search(keyword)
                    .small.text-muted.mt-1 Tìm theo tên, số điện thoại, địa chỉ khách hàng
            .col-md-6
                .bg-white.p-3.rounded.border
                    label.form-label.fw-semibold.mb-2 Sắp xếp
                    +sort()

        // Multi Action
        if(role.permissions.includes("orders_edit"))
            .mb-3
                +form-change-multi(`${prefixAdmin}/info-order/change-multi?_method=PATCH`)

        // Orders Table
        .bg-white.rounded-3.shadow-sm.overflow-hidden
            .table-responsive
                table.table.table-hover.mb-0.admin-table(checkbox-multi)
                    thead
                        tr
                            th.py-4.px-4.border-0.text-center(width="60" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);")
                                .custom-control.custom-checkbox
                                    input.custom-control-input.form-check-input(type="checkbox" name="checkall" id="checkall-orders")
                                    label.custom-control-label(for="checkall-orders")
                            th.py-4.border-0.text-center.fw-bold.text-muted(width="70" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);")
                                i.fas.fa-hashtag.me-1
                                | STT
                            th.py-4.border-0.text-center.fw-bold.text-muted(width="120" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);")
                                i.fas.fa-barcode.me-1
                                | Mã đơn hàng
                            th.py-4.border-0.fw-bold.text-muted(width="200" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);")
                                i.fas.fa-user.me-1
                                | Khách hàng
                            th.py-4.border-0.text-center.fw-bold.text-muted(width="100" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);")
                                i.fas.fa-cubes.me-1
                                | Số lượng
                            th.py-4.border-0.text-center.fw-bold.text-muted(width="120" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);")
                                i.fas.fa-dollar-sign.me-1
                                | Tổng tiền
                            th.py-4.border-0.text-center.fw-bold.text-muted(width="130" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);")
                                i.fas.fa-toggle-on.me-1
                                | Trạng thái
                            th.py-4.border-0.text-center.fw-bold.text-muted(width="150" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);")
                                i.fas.fa-clock.me-1
                                | Thời gian
                            th.py-4.border-0.text-center.fw-bold.text-muted(width="160" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);")
                                i.fas.fa-cogs.me-1
                                | Thao tác

                    tbody
                        each item, index in orders
                            tr.table-row-hover.align-middle
                                td.px-4.text-center
                                    .custom-control.custom-checkbox
                                        input.custom-control-input(
                                            type="checkbox"
                                            name="id"
                                            value=item.id
                                            id=`checkbox-order-${item.id}`
                                        )
                                        label.custom-control-label(for=`checkbox-order-${item.id}`)
                                
                                td.text-center.fw-bold.text-muted
                                    | #{pagination.limitItems*(pagination.currentPage - 1) + (index + 1)}
                                
                                td.text-center.align-middle
                                    .order-code
                                        .badge.bg-primary.bg-opacity-10.text-primary.px-3.py-2.rounded-pill.fw-semibold
                                            i.fas.fa-receipt.me-1
                                            | ##{item._id.toString().slice(-6).toUpperCase()}
                                
                                td.align-middle
                                    .customer-info
                                        .fw-semibold.text-dark #{item.userInfo.fullName}
                                        .small.text-muted.mt-1
                                            i.fas.fa-phone.me-1
                                            | #{item.userInfo.phone}
                                        .small.text-muted
                                            i.fas.fa-map-marker-alt.me-1
                                            | #{item.userInfo.address.substring(0, 30)}...
                                
                                td.text-center.align-middle
                                    .quantity-badge
                                        .badge.bg-info.bg-opacity-10.text-info.px-3.py-2.rounded-pill.fw-semibold
                                            i.fas.fa-box.me-1
                                            | #{item.totalQuantity}
                                
                                td.text-center.align-middle
                                    .total-price
                                        .fw-bold.text-success.fs-6 #{item.totalPrice}$
                                        .small.text-muted USD
                                
                                td.text-center.align-middle
                                    span.badge.bg-success.text-white.px-3.py-2.rounded-pill(style="font-size: 12px;")
                                        i.fas.fa-check-circle.me-1
                                        | Hoàn thành
                                
                                td.text-center.align-middle
                                    .order-time
                                        .small.fw-semibold.text-dark Khách hàng
                                        .small.text-muted.mt-1
                                            +formatDateTime(item.createdAt)
                                
                                td.text-center.align-middle
                                    .btn-group.btn-group-sm(role="group")
                                        a.btn.btn-outline-info.btn-sm.rounded-pill.me-1(
                                            href=`${prefixAdmin}/info-order/detail/${item.id}`
                                            title="Xem chi tiết"
                                        )
                                            i.fas.fa-eye
                                        
                                        if(role.permissions.includes("orders_delete"))
                                            button.btn.btn-outline-danger.btn-sm.rounded-pill(
                                                button-delete
                                                data-id=item.id
                                                title="Xóa đơn hàng"
                                            )
                                                i.fas.fa-trash-alt
        // Pagination
        .d-flex.justify-content-center.mt-4
            +pagination(pagination)

    // Hidden Forms
    form#form-change-status(
        action=""
        method="POST"
        data-path=`${prefixAdmin}/info-order/change-status`
    )

    form#form-delete-item(
        action=""
        method="POST"
        data-path=`${prefixAdmin}/info-order/delete`
    )

    script(src="/admin/js/product.js") 
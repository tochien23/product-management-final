extends ../../layouts/default.pug
include ../../mixins/alert.pug
include ../../mixins/moment.pug

block main 
    +alert-success(5000)
    +alert-error(5000)

    if order
        // Header Section
        .page-header.bg-white.rounded-3.shadow-sm.p-4.mb-4
            .d-flex.justify-content-between.align-items-center
                .header-info
                    .breadcrumb-nav.mb-2
                        a.text-decoration-none.text-muted(href=`${prefixAdmin}/info-order`)
                            i.fas.fa-arrow-left.me-2
                            | Quay lại danh sách
                        span.mx-2 /
                        span.text-dark Chi tiết đơn hàng
                    
                    h1.h3.fw-bold.mb-0
                        i.fas.fa-file-invoice.me-2.text-primary
                        | Đơn hàng ##{order._id.toString().slice(-6).toUpperCase()}
                
                .header-actions.d-flex.gap-2
                    a.btn.btn-outline-primary(href=`${prefixAdmin}/info-order`)
                        i.fas.fa-list.me-2
                        | Danh sách đơn hàng
                    button.btn.btn-outline-info(onclick="window.print()")
                        i.fas.fa-print.me-2
                        | In đơn hàng

        // Order Overview
        .row.mb-4
            .col-md-6
                .info-card.bg-white.rounded-3.shadow-sm.p-4.h-100
                    h5.fw-bold.mb-3
                        i.fas.fa-info-circle.me-2.text-primary
                        | Thông tin đơn hàng
                    .order-info
                        .info-row.mb-3
                            strong.text-muted Mã đơn hàng: 
                            span.text-primary.fw-bold ##{order._id.toString().slice(-6).toUpperCase()}
                        .info-row.mb-3
                            strong.text-muted Ngày đặt: 
                            +formatDateTime(order.createdAt)
                        .info-row.mb-3
                            strong.text-muted Số lượng sản phẩm: 
                            span.badge.bg-info #{order.products.length}
                        .info-row.mb-3
                            strong.text-muted Trạng thái: 
                            span.badge.bg-success
                                i.fas.fa-check-circle.me-1
                                | Hoàn thành
                        .info-row.mb-3
                            strong.text-muted Tổng tiền: 
                            span.fw-bold.text-success.fs-5 #{order.totalPrice}$
            
            .col-md-6
                .customer-card.bg-white.rounded-3.shadow-sm.p-4.h-100
                    h5.fw-bold.mb-3
                        i.fas.fa-user.me-2.text-primary
                        | Thông tin khách hàng
                    .customer-info
                        .info-row.mb-3
                            strong.text-muted Họ tên: 
                            span #{order.userInfo.fullName}
                        .info-row.mb-3
                            strong.text-muted Số điện thoại: 
                            a.text-decoration-none(href=`tel:${order.userInfo.phone}`) #{order.userInfo.phone}
                        .info-row
                            strong.text-muted Địa chỉ: 
                            span #{order.userInfo.address}

        // Order Products
        .products-section.bg-white.rounded-3.shadow-sm.p-4.mb-4
            h5.fw-bold.mb-4
                i.fas.fa-shopping-bag.me-2.text-primary
                | Sản phẩm đã đặt (#{order.products.length} sản phẩm)
            
            .products-list
                each product, index in order.products
                    .product-item.border.rounded-3.p-3.mb-3(class=index === order.products.length - 1 ? 'mb-0' : '')
                        .row.align-items-center
                            .col-md-1.text-center
                                .product-number
                                    .number-badge.bg-primary.text-white.rounded-circle.d-inline-flex.align-items-center.justify-content-center.fw-bold(style="width: 30px; height: 30px;") #{index + 1}
                            
                            .col-md-2.text-center
                                .product-image
                                    img.img-fluid.rounded(
                                        src=product.productInfo.thumbnail
                                        alt=product.productInfo.title
                                        style="max-height: 80px; object-fit: cover;"
                                    )
                            
                            .col-md-4
                                .product-details
                                    h6.fw-bold.mb-1
                                        a.text-decoration-none.text-dark(href=`/products/detail/${product.productInfo.slug}` target="_blank") 
                                            | #{product.productInfo.title}
                                    .price-info
                                        .original-price.text-muted.small
                                            | Giá gốc: #{product.price}$
                                        if product.discountPercentage > 0
                                            .discount.text-danger.small
                                                | Giảm giá: #{product.discountPercentage}%
                            
                            .col-md-2.text-center
                                .quantity-info
                                    .quantity-label.small.text-muted Số lượng
                                    .quantity-value.fw-bold.fs-4.text-primary #{product.quantity}
                            
                            .col-md-2.text-center
                                .price-info
                                    .price-label.small.text-muted Đơn giá
                                    .price-value.fw-bold.text-success #{product.priceNew}$
                            
                            .col-md-1.text-center
                                .total-info
                                    .total-label.small.text-muted Thành tiền
                                    .total-value.fw-bold.text-success.fs-5 #{product.totalPrice}$

        // Order Summary
        .summary-section.bg-white.rounded-3.shadow-sm.p-4.mb-4
            .row.justify-content-end
                .col-lg-6
                    h5.fw-bold.mb-3
                        i.fas.fa-calculator.me-2.text-primary
                        | Tóm tắt đơn hàng
                    
                    .summary-details
                        .summary-row.d-flex.justify-content-between.mb-2
                            span Tạm tính:
                            span.fw-semibold #{order.totalPrice}$
                        
                        .summary-row.d-flex.justify-content-between.mb-2
                            span Phí vận chuyển:
                            span.text-success
                                i.fas.fa-gift.me-1
                                | Miễn phí
                        
                        .summary-row.d-flex.justify-content-between.mb-2
                            span Thuế VAT:
                            span Đã bao gồm
                        
                        hr.my-3
                        
                        .summary-total.d-flex.justify-content-between.align-items-center
                            span.fw-bold.fs-4 Tổng đơn hàng:
                            span.fw-bold.text-success.fs-3 #{order.totalPrice}$

        // Admin Actions
        .actions-section.bg-white.rounded-3.shadow-sm.p-4
            h5.fw-bold.mb-3
                i.fas.fa-cogs.me-2.text-primary
                | Thao tác quản lý
            
            .d-flex.gap-2
                a.btn.btn-outline-primary(href=`${prefixAdmin}/info-order`)
                    i.fas.fa-list.me-2
                    | Danh sách đơn hàng
                
                button.btn.btn-outline-info(onclick="window.print()")
                    i.fas.fa-print.me-2
                    | In đơn hàng
                
                if(role.permissions.includes("orders_delete"))
                    button.btn.btn-outline-danger(
                        type="button"
                        data-bs-toggle="modal"
                        data-bs-target="#deleteModal"
                    )
                        i.fas.fa-trash-alt.me-2
                        | Xóa đơn hàng

        // Delete Modal
        if(role.permissions.includes("orders_delete"))
            .modal.fade#deleteModal(tabindex="-1")
                .modal-dialog.modal-dialog-centered
                    .modal-content
                        .modal-header
                            h5.modal-title.text-danger
                                i.fas.fa-exclamation-triangle.me-2
                                | Xác nhận xóa đơn hàng
                            button.btn-close(type="button" data-bs-dismiss="modal")
                        .modal-body.text-center
                            .mb-3
                                i.fas.fa-trash-alt.fa-3x.text-danger.opacity-50
                            h6.mb-3 Bạn có chắc chắn muốn xóa đơn hàng này?
                            .alert.alert-warning
                                | Đơn hàng: ##{order._id.toString().slice(-6).toUpperCase()}
                            p.text-muted.small Hành động này không thể hoàn tác
                        .modal-footer
                            button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Hủy bỏ
                            a.btn.btn-danger(
                                href=`${prefixAdmin}/info-order/delete/${order._id}?_method=DELETE`
                                onclick="return confirm('Bạn có chắc chắn muốn xóa đơn hàng này?')"
                            ) Xóa đơn hàng
    
    else
        .error-section.text-center.py-5
            .bg-white.rounded-3.shadow-sm.p-5
                i.fas.fa-exclamation-triangle.fa-4x.text-warning.mb-4
                h3.fw-bold.text-muted.mb-3 Không tìm thấy đơn hàng
                p.text-muted.mb-4 Đơn hàng có thể đã bị xóa hoặc không tồn tại.
                a.btn.btn-primary(href=`${prefixAdmin}/info-order`)
                    i.fas.fa-arrow-left.me-2
                    | Quay lại danh sách

    // Print Styles
    style.
        @media print {
            .header-actions, .actions-section, .btn {
                display: none !important;
            }
            
            .page-header, .info-card, .customer-card, .products-section, .summary-section {
                box-shadow: none !important;
                border: 1px solid #dee2e6 !important;
            }
        }
        
        .info-card, .customer-card, .products-section, .summary-section, .actions-section {
            transition: all 0.3s ease;
        }
        
        .info-card:hover, .customer-card:hover, .products-section:hover, .summary-section:hover, .actions-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
        }
        
        .product-item {
            transition: all 0.3s ease;
        }
        
        .product-item:hover {
            background-color: #f8f9fa;
            transform: scale(1.01);
        }
        
        .number-badge {
            transition: all 0.3s ease;
        }
        
        .product-item:hover .number-badge {
            transform: scale(1.1);
        } 